env:
  global:
  # Docker Repository
  - REPO=fjudith/waarp-r66
  # Compute docker tag
  - TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  # Retreive commit ID
  - COMMIT=${TRAVIS_COMMIT::8}
  - secure: "Q+DT89N4kqFgeCZVFqH60FNazQSPMp9s94/Mn+/o2OKQOrZHxP7tnQoNDspkSbZaZ4oprqKigxLJdHQGiR4Y+3ado76q4YLsJsqshrnjgn/oZhyg6D/sPO4Y4dVzwCGyXNSkyei7PIkCWEspTIU6UTgf/G5VgzbS6tdlw23Jot+UofGKbQzhdh7Robe1wTHemmNyjuz1zF6aFg/FWCDZZjAbsLueuXDJfdeRIlPKh4nVfCEbBODKSg0JjuY8NaeafoVCEj/6nfpIwXrUTxAJG/Z1HOey/m9eAIGhttXxX1+w/tWIABOJm5N56ufG5biCebcQ6epT514AK+ZvQGgqyVPunSOQvnLYShc+bXACH6nVQSCqs5RtgsB5N1GghIpNgcGEXSNP1vZkK/YfypHe9F5p6AEtPprPmQXVGs4VpS4pzCKDUHSlQ6hOsEeP1iSZGW8JLBqW8Ns06U4v5ffasQnrNTQ4zjwsMZT5+E5gpEfvU7U5DnhWcwtREa4E6p4t2tcrEyjMxXBS5xhGYsCyehdJv9HNorOJ+60KXa51jDut4GmCTihmZMBlo3PyHYuB/j0/z9aYenaeTwmzVQouR7umOmUtl/lzpRTTdxfV9DQftu77kH7lwm7QUXNtG6j6pYzJQlcwXgTaosCfXAin/Kk0faeL0AxzN6BggKfSRWU="
  - secure: "awDyqXhEnbwD1+w0ozt++kP84GrvK6kdJZrj1PRY8WD5fUCk6YiKFMBiUtPZjaA00+cw7B8bmGT8o1pHdPnjknEU2UuiNUfjk8/CtZqIxwcW/htGdZ7bqPUWw47dh1se8uc7HRY3P2DV/RNdZ1e+iMXEZxfZF/mXoaw3+NFoShuQq1UVbjMcyR05ZLdzU8OAhxaxDcSDiLUNm4rDYVnFVYQk2EE+IyiWRVaZpPtAr+CB1t4Fa0VSavEa+pFMYRYzxoHxqNyyY3r3eBW/CsfkrW4iDbm00Zvgi97hHilWPTRVlMsjtRSDCOlTtVWIhMzU/3a2DF4yaMy71HZnx9xVMcDoLYW1fupYJl46wzOhgCD9dQnCZHldHuagRAjz+K6S1BDoSQXWHeKHgjTzJoSs5HQ1ufjnAbNdg20qIJU4ItVWG5WsWpk2eDojvyEyIl1kbuTfMcFutuxUAlZHBFgSfVgFJhoR75Ox/GPfFFilQ2zqkuaHR0g5I0nxv97UXLKdIXwosjD8oW2F8UM8tVDhrNC42Skc/L+FTcV1wivGvztmOU/HtBhlsFnFfj4RsNvvZOK/4klNRw/J55ro5w7FZpudxxx1syjk6yF7xBXIm8G5UUWNk3x+DlqSpkqprsYWqh5fh8THtwwUaJw4kwaJQ/oFXy4knw+WLEAiiJB1Pvg="
  
sudo: required
services:
  - docker


before_install:
  - pushd ./alpine/ && docker-compose -f ./docker-compose.yml -p waarp1 up --build -d --force-recreate && popd
  - pushd ./centos/ && docker-compose -f ./docker-compose.alpine.yml -p waarp2 up --build -d --force-recreate && popd
  - WAARP1_CONTAINERID=$(docker ps -qa -f name="waarp1_waarp-r66_1")
  - WAARP2_CONTAINERID=$(docker ps -qa -f name="waarp2_waarp-r66_1")


script:
  # Wait for Waarp-R66 to start
  - sleep 20
  - docker ps -a
  - docker logs ${WAARP1_CONTAINERID} 
  - docker logs ${WAARP2_CONTAINERID} 
  # -i, --include – include protocol headers in the output (H/F)
  # -X, --request – specify request  COMMAND (GET, PUT, DELETE…)  to use
  - docker exec ${WAARP1_CONTAINERID} /bin/bash -c "curl -i http://localhost:8066"
  - docker exec ${WAARP2_CONTAINERID} /bin/bash -c "curl -i http://localhost:8066"


after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO