env:
  global:
  # Docker Repository
  - REPO=fjudith/waarp-r66
  # Compute docker tag
  - TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo ${TRAVIS_BRANCH} ; fi`
  - ALPINE_TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "alpine"; else echo ${TRAVIS_BRANCH}-alpine ; fi`
  # Retreive commit ID
  - COMMIT=${TRAVIS_COMMIT::8}
  - secure: "lUaLQAkFDJXM1JlzV/urv0WfasfS3ud0bFMANlYURt3JVl6530tG/4/SnnJyulFAl6NZp13yvRfAXv3tlZJLDTlmeZUJm1QhZef8zzcNxCp/a2KB12pNTb+kBW/WbyM+rZktAkWuMQXfa6byxI2zhX9jMLP/3qUuI+pgtAXwKjXi8O25LGJJV2jECJkuHmKTz7SpPGKkrqUJsnjyqu++mh+dXtrvj/2UDx4gYVTGVu3lV66MzEh7XZTtDYSGl4QWxFEpiU3GHsav9GnxbdckOT0ILZZSglzQbxksTAp7cNqsQfxU/5/VVAvARS4gQaR0Jw4hmGxQq2ecjs/9U1BMt8puLasiheZnhksmQs6IC5DoKbJCU4txH1v8bqQu93aEkkFoyktlqX9FOLuTg703QYfv8l6zBApoLMPG0jssbjKmMYBQ8+EBZFBKbOc6r92mjevRI/1mg3nClPEsTayGrG1dSLTMKzUaOF2geBJmpgvH/GE0EybyjvlcjAdFCWfZDj4gITlu6/JixzYaiyeUH+O5ULyOpJfSw67NkDPzbBryu1Tj6MLNcecpPums8g6FoGuDHKv/aCxRhsOdGQKJGGQhVn9814KDJE8ChU5y40GQLhRNOZH2YAePa4cHwh/iT27+qkc4zNn4B0ULkrhflQiqza+858BpTn6aCGMYtkI="
  - secure: "Kj+HQlhJ23ovekUiaxfH8ewzIGTJn7wB+MJnhvWWJ+yDjUGTAP06kamoLa6N2b4ReLHxBz3pHw8pG9FEQP3+JwVjYiL8jmtpyinrLDtfMhQLnevQXOjJI8A3qlA50Mjgbh0hMHPALH3ZsMhNF1Wfr8a8WINb9pdszp+tAIgd0JTMkQM66IZPJaxzWl5PUsMEjmp9PtxJh29osuAKL6cw16b8NGvI92jrW6YfDgaCcIW56Vt906dU095bF6sF7MbN39nnwhEEK5kF3ZwPVOSXTnkU7ZcYp0Q9Ybl65o1UzYZyQp4CRI0Og5Vug13K1svObTMUlvSo9PM5tQioVIRCLhhLmtW4A3H5C/jcrUH+4W2IweaPRebxSRSe1pLjX4O2+5zbl6YA3gpFLoowNn1YfpSYPNlg9W3G1tViMCphxiSnrV86FUja3ePVF1S2zhg0zDqUql+T6ZOyuWRR/7TSkVaXUc3m1yrvbIRT2uxjd5BF8XEtpEwA8FrRIhDr2C9StMPmxWNkvj8S/TjoH4UhJ07qR3IftAQ4BQG3FL/EhiFC3SJeLRG7Lkij7+WkUGNlDmABZ7Xll7NQCrzMRCFfE3fz1rfHZiCLJnSj6kjovi0ojaleNpa3TGjWVMpwfIWc3npLB6iGEDjqR1bKiEJPdVWUVkWRLO06VykX6iS6v/4="
  
sudo: required
services:
  - docker


before_install:
  - pushd ./centos/ && docker-compose -f ./docker-compose.yml -p waarp1 up --build -d --force-recreate && popd
  - pushd ./alpine/ && docker-compose -f ./docker-compose.yml -p waarp2 up --build -d --force-recreate && popd
  - WAARP1_CONTAINERID=$(docker ps -qa -f name="waarp1_waarp-r66_1")
  - WAARP2_CONTAINERID=$(docker ps -qa -f name="waarp2_waarp-r66_1")


script:
  # Wait for Waarp-R66 to start
  - sleep 20
  - docker ps -a
  - docker logs ${WAARP1_CONTAINERID} 
  - docker logs ${WAARP2_CONTAINERID} 
  # -i, --include – include protocol headers in the output (H/F)
  # -X, --request – specify request  COMMAND (GET, PUT, DELETE…)  to use
  - docker exec ${WAARP1_CONTAINERID} /bin/bash -c "curl -i http://localhost:8066"
  - docker exec ${WAARP2_CONTAINERID} /bin/bash -c "curl -i http://localhost:8066"


after_success:
  - docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
  - docker tag ${REPO}:${TAG} ${REPO}:travis-${TRAVIS_BUILD_NUMBER}
  - docker tag ${REPO}:${ALPINE_TAG} ${REPO}:travis-${TRAVIS_BUILD_NUMBER}-alpine
  - docker push $REPO